# HiAgent 企业AI中台项目经历

## 项目基本信息

- **项目名称**: HiAgent 企业AI中台
- **项目时间**: 实习期间
- **项目角色**: 后端开发工程师
- **技术栈**: Java 17, Spring Boot, MongoDB, Elasticsearch, Redis, Thrift, MapStruct, CompletableFuture, 分布式锁, 令牌桶限流

## 项目介绍

HiAgent是火山引擎推出的企业AI中台，基于Agent DevOps理念，提供智能体开发、评测、观测、优化全生命周期管理，支持模型接入、推理、精调及私有化集成，助力企业高效构建生产级高价值智能体，实现从模型到应用的全链路打通。

### 核心功能特点

- **低代码快速搭建智能体**: 提供100+插件、MCP（模型上下文协议）、100+企业场景智能体模板，支持发布到飞书、钉钉、微信等IM渠道，也可通过API、WebSDK形式与企业存量系统集成
- **智能体和大模型全链路运维运营**: 评测系统多维度定量评估智能体和大模型表现效果，观测系统实时监控智能体性能、效果及用户反馈，数据工程系统助力生成优质数据
- **一站式模型训练和推理**: 支持各类三方模型接入，可托管企业自有算力进行模型推理和训练，提供一站式模型推理、数据、精调服务
- **全生命周期安全防护**: 严格遵循数据不出域原则，审计日志可追溯，大模型防火墙阻断攻击确保安全合规
- **企业级服务**: 支持私有化部署，提供丰富的配套管理功能和灵活的开放集成能力，覆盖200+行业场景，已成功落地Agent 500+款

### 应用场景

- **智能营销助手**: 涵盖营销素材生成、产品卖点提炼、客群精准匹配等
- **智慧学伴**: 面向学生的个性化学习伙伴，通过答疑解惑、推荐学习内容等方式自适应提升学习效率
- **HR助手**: 人力资源管理的AI帮手，自动化处理招聘、考勤、员工咨询等事务性工作，优化HR流程
- **智能客服**: 智能回答常见问题，涵盖产品推荐、订单跟踪、投诉处理等场景，提升产品全链路服务体验
- **企业办公助手**: 不仅能够记录会议内容、整理会议纪要，还能准确审查合同条款，降低企业交易风险

### 行业案例

- **浙江大学**: 携手火山引擎，依托HiAgent平台，7天高效落地"浙大先生"大模型应用体系，为5万+在校师生打造智能化的教学教务、科研创新、校园生活体验
- **爱玛科技**: 通过HiAgent平台构建"AI智慧大脑"，打造四类AI场景，为B端、C端超40,000人提供服务，办公效率提升300%、跨国协作提效50%，员工服务首次联系解决率达90%

## 主要职责与工作内容

### 1. OpenAPI接口设计与开发

#### 1.1 需求背景

为满足数据分析需求，需要记录并查询Agent的调用日志明细。最初提供两种方案：

- 方案一：数据表方式，支持MySQL和MongoDB
- 方案二：通过OpenAPI方式，提供HTTP接口，配合鉴权逻辑

由于字节云与火山云环境不互通，数据表方案难以兼容，最终选择了OpenAPI接口方案。

#### 1.2 技术挑战与解决方案

**问题**: 部分热门Agent调用日志量巨大，导致查询频繁超时

- MongoDB在数据量达到约10,000条时，翻页查询性能急剧下降
- 初步优化：延长MongoDB连接超时时间至2分钟，但效果有限

**解决方案**: 数据存储架构优化

- 将日志数据从MongoDB迁移至Elasticsearch
- 迁移后查询性能有明显改善，但需进一步优化接口分页、限流机制

#### 1.3 技术实现

- 实现AK/SK鉴权机制，解析得到租户ID，确保数据安全合规
- 设计分页查询接口，限制单次最大查询量
- 实现异步导出机制，支持大批量数据需求

### 2. 联网搜索功能优化

#### 2.1 核心问题定位

在实现基于火山方舟搜索能力的联网搜索功能时，发现单次调用耗时长达20-30秒，存在以下痛点：

- **用户体验层面**: 无状态提示，用户无法感知搜索进度
- **性能层面**: 火山方舟客户端重复创建导致资源浪费，同步调用阻塞线程

#### 2.2 优化策略与技术实现

**2.2.1 用户体验优化：前置状态反馈**

- 后端新增supportWebSearch标志位，标识联网搜索状态
- 前端监听标志位，实时展示「联网搜索中...」loading提示
- 效果：明确用户预期，减少焦虑感

**2.2.2 性能优化：全链路效率提升**

1. **客户端资源复用：缓存火山方舟实例**

   - 创建单例模式的ArkServiceCache缓存层
   - 首次调用时初始化火山方舟客户端，后续请求直接从缓存获取
   - 收益：消除客户端创建开销，单次调用基础耗时降低约3秒
2. **异步化改造：CompletableFuture + 自定义线程池**

   ```java
   // 改造前：同步阻塞调用
   String result = arkClient.search(query);

   // 改造后：异步非阻塞调用
   CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> 
       arkClient.search(query), customThreadPool
   );
   ```

   **线程池优化**:

   - 使用ThreadPoolExecutor自定义线程池
   - 核心线程数：Runtime.getRuntime().availableProcessors() * 2
   - 队列容量：1024
   - 拒绝策略：CallerRunsPolicy（避免任务丢失）
3. **异步日志追踪：装饰器模式集成MDC**

   - 问题：异步线程中MDC上下文丢失，导致日志无法关联请求链路
   - 解决方案：创建MdcThreadPoolDecorator装饰器，包装线程池的execute和submit方法
   - 在任务提交前注入当前请求的traceId到MDC，确保异步日志携带完整上下文
4. **RAG流程优化：异步顺序调整**

   - 原流程：联网搜索（同步）→RAG处理（同步）
   - 新流程：联网搜索（异步）+ RAG处理（异步）（通过thenCompose链式调用）
   - 收益：两个耗时操作并行执行，端到端响应时间进一步缩短约2秒

#### 2.3 优化效果数据

| 指标             | 优化前    | 优化后    | 提升幅度 |
| ---------------- | --------- | --------- | -------- |
| 单次调用耗时     | 20-30秒   | 13-15秒   | 40%-50%  |
| 多用户并发吞吐量 | 5请求/秒  | 15请求/秒 | 200%     |
| 日志排查耗时     | 30分钟/次 | 10分钟/次 | 66.7%    |

### 3. 系统性能优化与问题排查

#### 3.1 分布式限流器实现

**需求**: 防止模型访问过载，需要对模型调用进行限流控制

**技术实现**: 基于Redis的令牌桶算法分布式限流器

- 使用Lua脚本保证原子性操作
- 支持动态调整限流参数
- 实现异步等待机制，避免频繁轮询

**核心特性**:

- 分布式环境下的限流一致性
- 支持突发流量处理
- 自动过期清理机制

#### 3.2 可跳过的阻塞式分布式锁

**设计思路**: 优化缓存重建场景下的锁竞争问题

**实现机制**:

- 每次RPC建立缓存时设置标志位
- 后续相同内容直接跳过锁竞争，查询缓存
- 缓存不存在时重建缓存后返回结果

**优势**:

- 减少不必要的锁竞争
- 提升缓存命中率
- 降低系统延迟

#### 3.3 生产环境问题排查

**504超时问题排查**:

- 问题：CDN回流超时，无logId等排查信息
- 处理过程：
  - Oncall紧急拉齐多个部门协同排查
  - 排查链路：CDN > TLB > Janus > PSM
  - 最终确认请求在CDN处超时
  - TLB能获取到logId，但CDN无相关日志

**环境配置问题**:

- 网关Janus相关内容，网关上没有更新IDL，导致输出被网关过滤
- TLB问题，内容分发OpenAPI接口没有配置接口，导致接口鉴权调不通
- CDN问题，回流超时默认30s，但个别Agent用户配置复杂，导致Agent执行结果返回时在CDN处超时

## 技术产出与成果

### 1. 性能优化成果

- **联网搜索响应时间优化50%**，从20-30秒降至13-15秒
- **多用户并发吞吐量提升200%**，从5请求/秒提升至15请求/秒
- **日志排查效率提升66.7%**，从30分钟/次降至10分钟/次
- 通过ES迁移解决MongoDB大数据量查询超时问题
- 实现分布式限流，有效防止系统过载

### 2. 技术方案设计

- **可跳过的阻塞式分布式锁机制**：提升缓存重建效率，减少锁竞争
- **装饰器模式包装线程池**：解决异步日志追踪问题，确保MDC上下文传递
- **ArkServiceCache缓存层**：消除客户端重复创建开销，提升资源利用效率
- **令牌桶分布式限流器**：基于Redis实现，支持动态调整和异步等待

### 3. 代码质量提升

- 使用CompletableFuture实现异步化改造，提升系统并发处理能力
- 采用ThreadPoolExecutor自定义线程池，优化资源利用和任务调度
- 实现MDC上下文传递，确保异步日志链路完整性和可追踪性
- 解决MapStruct和Thrift生成代码过多导致的OOM问题

### 4. 业务价值贡献

- **用户体验显著提升**：联网搜索状态提示、响应时间优化
- **系统稳定性保障**：分布式限流、异步化改造、问题快速定位
- **运维效率提升**：完善的日志追踪机制、快速问题排查能力
- **技术债务清理**：解决历史遗留的性能瓶颈和架构问题

## 技术难点与解决方案

### 1. 大数据量查询性能优化

**难点**: MongoDB在10万+数据量下翻页查询性能急剧下降
**解决方案**:

- 数据存储架构从MongoDB迁移至Elasticsearch
- 实现分页查询和异步导出机制
- 设计冷热数据分层策略

### 2. 异步日志追踪问题

**难点**: 异步线程中MDC上下文丢失，无法关联请求链路
**解决方案**:

- 设计装饰器模式包装线程池
- 在任务提交前注入traceId到MDC
- 确保异步日志携带完整上下文信息

### 3. 分布式环境下的限流一致性

**难点**: 多实例环境下的限流策略一致性
**解决方案**:

- 基于Redis实现分布式令牌桶算法
- 使用Lua脚本保证原子性操作
- 支持动态调整限流参数

## 项目总结与反思

### 1. 技术收获

- 深入理解分布式系统设计原则和性能优化策略
- 掌握异步编程模式和线程池调优技巧
- 提升复杂问题排查和系统调试能力
- 学会在业务需求和技术实现之间找到平衡点

### 2. 经验教训

- **性能优化需要数据支撑**：通过具体指标量化优化效果
- **异步化改造需要全面考虑**：不仅要考虑性能提升，还要考虑日志追踪、异常处理等
- **生产环境问题排查需要系统性思维**：建立完整的监控和日志体系
- **技术选型需要权衡**：在功能需求、性能要求、维护成本之间找到最优解

### 3. 后续优化方向

- **客户端缓存升级**：引入Redis实现跨进程客户端实例缓存，支持集群环境
- **流式搜索支持**：与火山方舟对接流式返回接口，实现结果边搜索边展示
- **熔断与降级**：添加Hystrix熔断机制，避免搜索服务异常拖垮整个系统
- **监控体系完善**：建立完整的性能监控和告警机制

## 简历亮点提炼

### 核心成就

- **性能优化专家**：将联网搜索响应时间优化50%，并发吞吐量提升200%
- **问题解决能手**：成功解决生产环境504超时、异步日志追踪等技术难题
- **架构设计能力**：设计并实现分布式限流器、可跳过分布式锁等创新方案
- **业务价值导向**：通过技术手段显著提升用户体验和系统稳定性

### 技术能力展示

- **分布式系统设计**：Redis分布式限流、Elasticsearch数据迁移
- **异步编程精通**：CompletableFuture、自定义线程池、装饰器模式
- **性能调优经验**：从20-30秒优化至13-15秒，提升66.7%排查效率
- **问题排查能力**：复杂链路问题定位、生产环境故障处理

### 软技能体现

- **跨部门协作**：与多个部门协同解决紧急生产问题
- **技术方案设计**：在功能需求、性能要求、维护成本间找到平衡
- **持续优化思维**：从用户体验、系统性能、运维效率多维度持续改进
- **学习能力**：快速掌握新技术并应用到实际项目中
